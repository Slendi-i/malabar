#!/bin/bash

# ะัััััะน ะฟะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ ะฝะฐ VPS
# ะัะฟะพะปัะทัะนัะต ััะพั ัะบัะธะฟั ะดะปั ะฑััััะพะณะพ ะฟัะธะผะตะฝะตะฝะธั ะธะทะผะตะฝะตะฝะธะน

echo "๐ ะัััััะน ะฟะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ Malabar..."

# ะฆะฒะตัะฐ
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[$(date '+%H:%M:%S')]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

# ะะตัะตัะพะด ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd /var/www/malabar || {
    error "ะะต ะฝะฐะนะดะตะฝะฐ ะดะธัะตะบัะพัะธั /var/www/malabar"
    exit 1
}

log "โน๏ธ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ัะตัะฒะธัั..."
pm2 stop all

log "๐ ะัะธะผะตะฝัะตะผ git ะธะทะผะตะฝะตะฝะธั..."
git stash
git pull origin main || warn "Git pull failed"

log "๐๏ธ ะะตัะตัะฑะพัะบะฐ ะฟัะพะตะบัะฐ..."
npm run build

log "โถ๏ธ ะะฐะฟััะบะฐะตะผ ัะตัะฒะธัั..."
pm2 start ecosystem.config.js

# ะะดะตะผ ะทะฐะฟััะบะฐ
sleep 5

log "๐งช ะััััะฐั ะฟัะพะฒะตัะบะฐ..."

# ะัะพะฒะตััะตะผ ะฑัะบะตะฝะด
if curl -f -s "http://localhost:3001/api/health" > /dev/null; then
    log "โ ะัะบะตะฝะด ัะฐะฑะพัะฐะตั"
else
    error "โ ะัะบะตะฝะด ะฝะต ะพัะฒะตัะฐะตั"
    pm2 logs malabar-server --lines 10
fi

# ะัะพะฒะตััะตะผ ััะพะฝัะตะฝะด
if curl -f -s "http://localhost:3000" > /dev/null; then
    log "โ ะคัะพะฝัะตะฝะด ัะฐะฑะพัะฐะตั"
else
    warn "โ๏ธ ะคัะพะฝัะตะฝะด ะตัะต ะทะฐะฟััะบะฐะตััั..."
fi

log "๐ ะกัะฐััั ัะตัะฒะธัะพะฒ:"
pm2 status

echo ""
echo "๐ ะะตัะตะทะฐะฟััะบ ะทะฐะฒะตััะตะฝ!"
echo "๐งช ะะปั ะฟะพะปะฝะพะน ะฟัะพะฒะตัะบะธ ะทะฐะฟัััะธัะต: node test-sync-fixes.js"
