#!/bin/bash

# –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞ –±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏–π

echo "üèóÔ∏è –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
echo "==============================="

GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() { echo -e "${GREEN}[OK]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
info() { echo -e "${BLUE}[INFO]${NC} $1"; }

cd /var/www/malabar || { error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"; exit 1; }

echo ""
echo "üîç 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏"
echo "========================="

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
if [ ! -d "node_modules" ]; then
    error "node_modules –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    echo "–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
    echo "  ./install-critical-deps-vps.sh"
    exit 1
fi

MODULES_COUNT=$(ls node_modules 2>/dev/null | wc -l)
if [ "$MODULES_COUNT" -lt 20 ]; then
    warn "–ú–∞–ª–æ –º–æ–¥—É–ª–µ–π ($MODULES_COUNT), —Å–±–æ—Ä–∫–∞ –º–æ–∂–µ—Ç –Ω–µ —É–¥–∞—Ç—å—Å—è"
    echo "–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏:"
    echo "  ./install-deps-safe-vps.sh"
else
    log "–ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≥–æ—Ç–æ–≤—ã ($MODULES_COUNT –º–æ–¥—É–ª–µ–π)"
fi

echo ""
echo "üßπ 2. –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä–æ–π —Å–±–æ—Ä–∫–∏"
echo "=========================="

if [ -d ".next" ]; then
    rm -rf .next
    log "–°—Ç–∞—Ä–∞—è —Å–±–æ—Ä–∫–∞ —É–¥–∞–ª–µ–Ω–∞"
fi

if [ -d "out" ]; then
    rm -rf out
    log "–°—Ç–∞—Ä—ã–π export —É–¥–∞–ª–µ–Ω"
fi

echo ""
echo "üèóÔ∏è 3. –ó–∞–ø—É—Å–∫ —Å–±–æ—Ä–∫–∏"
echo "=================="

info "–ù–∞—á–∏–Ω–∞–µ–º —Å–±–æ—Ä–∫—É (–º–∞–∫—Å–∏–º—É–º 3 –º–∏–Ω—É—Ç—ã)..."

# –°–±–æ—Ä–∫–∞ —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –ø–æ–∫–∞–∑–æ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
timeout 180 npm run build &
BUILD_PID=$!

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
elapsed=0
while kill -0 $BUILD_PID 2>/dev/null; do
    sleep 10
    elapsed=$((elapsed + 10))
    echo "  ... —Å–±–æ—Ä–∫–∞ $elapsed —Å–µ–∫"
    
    if [ $elapsed -ge 180 ]; then
        echo "  –ü—Ä–µ–≤—ã—à–µ–Ω —Ç–∞–π–º–∞—É—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–±–æ—Ä–∫—É..."
        kill $BUILD_PID 2>/dev/null
        break
    fi
done

wait $BUILD_PID 2>/dev/null
BUILD_RESULT=$?

echo ""
echo "üìä 4. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏"
echo "====================="

if [ $BUILD_RESULT -eq 0 ] && [ -d ".next" ]; then
    log "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
    
    # –†–∞–∑–º–µ—Ä —Å–±–æ—Ä–∫–∏
    BUILD_SIZE=$(du -sh .next 2>/dev/null | cut -f1 || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
    log "–†–∞–∑–º–µ—Ä —Å–±–æ—Ä–∫–∏: $BUILD_SIZE"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–µ–≤—ã–µ —Ñ–∞–π–ª—ã
    if [ -f ".next/BUILD_ID" ]; then
        BUILD_ID=$(cat .next/BUILD_ID 2>/dev/null || echo "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ")
        log "Build ID: $BUILD_ID"
    fi
    
elif [ $BUILD_RESULT -eq 124 ]; then
    warn "‚è∞ –°–±–æ—Ä–∫–∞ –ø—Ä–µ–≤—ã—Å–∏–ª–∞ —Ç–∞–π–º–∞—É—Ç (3 –º–∏–Ω—É—Ç—ã)"
    
    if [ -d ".next" ]; then
        warn "–ß–∞—Å—Ç–∏—á–Ω–∞—è —Å–±–æ—Ä–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω–∞"
    else
        error "–°–±–æ—Ä–∫–∞ –Ω–µ —Å–æ–∑–¥–∞–Ω–∞"
    fi
    
else
    error "‚ùå –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ (–∫–æ–¥: $BUILD_RESULT)"
    
    echo ""
    echo "üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:"
    echo "1. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: ./install-deps-safe-vps.sh"
    echo "2. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ–∫ –ø–∞–º—è—Ç–∏: free -h"
    echo "3. –û—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã—à–µ"
fi

echo ""
echo "üíæ –ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ –ø–æ—Å–ª–µ —Å–±–æ—Ä–∫–∏:"
df -h . | head -2

echo ""
if [ -d ".next" ]; then
    log "üéâ –°–ë–û–†–ö–ê –ì–û–¢–û–í–ê!"
    echo ""
    echo "üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
    echo "1. –ó–∞–ø—É—Å–∫ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞: ./start-frontend-simple-vps.sh"
    echo "2. –ü–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: ./test-simple-vps.sh"
    echo ""
    echo "üí° –§—Ä–æ–Ω—Ç–µ–Ω–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ production —Ä–µ–∂–∏–º–µ (–±—ã—Å—Ç—Ä–µ–µ)"
else
    warn "‚ö†Ô∏è –°–ë–û–†–ö–ê –ù–ï –ì–û–¢–û–í–ê"
    echo ""
    echo "üîß –í–∞—Ä–∏–∞–Ω—Ç—ã:"
    echo "1. –ó–∞–ø—É—Å–∫ –≤ dev —Ä–µ–∂–∏–º–µ: ./start-frontend-simple-vps.sh"
    echo "2. –î–æ—É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π: ./install-deps-safe-vps.sh"
    echo "3. –ü–æ–≤—Ç–æ—Ä–Ω–∞—è —Å–±–æ—Ä–∫–∞: ./build-project-safe-vps.sh"
    echo ""
    echo "üí° Dev —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ —Å–±–æ—Ä–∫–∏, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ"
fi
