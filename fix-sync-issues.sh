#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ –ø—Ä–æ–µ–∫—Ç–µ Malabar
# –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—ã —Å:
# 1. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
# 2. –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–º–∏ —Ü–∏–∫–ª–∞–º–∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
# 3. –ö–æ–Ω—Ñ–ª–∏–∫—Ç–∞–º–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

echo "üîß –ù–∞—á–∏–Ω–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${GREEN}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –º—ã –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -f "package.json" ] || [ ! -f "server/server.js" ]; then
    error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞ Malabar"
    exit 1
fi

log "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
info "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "node.*server" || true
pkill -f "npm.*start" || true
pkill -f "next" || true

# –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
sleep 3

log "üíæ –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è..."
cp -r . ../malabar-backup-$(date +%Y%m%d_%H%M%S) 2>/dev/null || warn "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –±—ç–∫–∞–ø"

log "üóÉÔ∏è –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
if [ -f "server/malabar.db" ]; then
    info "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–∞ –≤ server/"
    DB_PATH="server/malabar.db"
elif [ -f "malabar.db" ]; then
    info "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–∞ –≤ –∫–æ—Ä–Ω–µ"
    DB_PATH="malabar.db"
else
    warn "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è"
    DB_PATH="server/malabar.db"
fi

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é server –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
mkdir -p server

log "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
if [ -f "package-lock.json" ]; then
    npm ci
else
    npm install
fi

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞
cd server
if [ -f "package-lock.json" ]; then
    npm ci
else
    npm install
fi
cd ..

log "üèóÔ∏è –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."

# –°–æ–±–∏—Ä–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥
npm run build

log "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä..."

# –ó–∞–ø—É—Å–∫–∞–µ–º –±—ç–∫–µ–Ω–¥
cd server
npm start &
SERVER_PID=$!
cd ..

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if curl -f -s "http://localhost:3001/api/health" > /dev/null; then
    log "‚úÖ –°–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
else
    error "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    kill $SERVER_PID 2>/dev/null || true
    exit 1
fi

log "üåê –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥..."

# –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –≤ production —Ä–µ–∂–∏–º–µ
npm start &
FRONTEND_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
sleep 5

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if curl -f -s "http://localhost:3000" > /dev/null; then
    log "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω"
else
    warn "‚ö†Ô∏è –§—Ä–æ–Ω—Ç–µ–Ω–¥ –≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –ø–æ–ª–Ω–æ—Å—Ç—å—é"
fi

log "üß™ –í—ã–ø–æ–ª–Ω—è–µ–º —Ç–µ—Å—Ç—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."

# –¢–µ—Å—Ç–∏—Ä—É–µ–º API
info "–¢–µ—Å—Ç–∏—Ä—É–µ–º API endpoints..."

# –¢–µ—Å—Ç health check
if curl -f -s "http://localhost:3001/api/health" | grep -q "OK"; then
    log "‚úÖ Health check —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    error "‚ùå Health check –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

# –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è –∏–≥—Ä–æ–∫–æ–≤
if curl -f -s "http://localhost:3001/api/players" | grep -q "players"; then
    log "‚úÖ API –∏–≥—Ä–æ–∫–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    error "‚ùå API –∏–≥—Ä–æ–∫–æ–≤ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

# –¢–µ—Å—Ç WebSocket (–ø—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø–æ—Ä—Ç —Å–ª—É—à–∞–µ—Ç—Å—è)
if netstat -tulpn 2>/dev/null | grep -q ":3001.*LISTEN" || ss -tulpn 2>/dev/null | grep -q ":3001.*LISTEN"; then
    log "‚úÖ WebSocket —Å–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 3001"
else
    warn "‚ö†Ô∏è WebSocket —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å"
fi

log "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤:"
echo "–°–µ—Ä–≤–µ—Ä PID: $SERVER_PID"
echo "–§—Ä–æ–Ω—Ç–µ–Ω–¥ PID: $FRONTEND_PID"

# –°–æ—Ö—Ä–∞–Ω—è–µ–º PID'—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
echo $SERVER_PID > server.pid
echo $FRONTEND_PID > frontend.pid

log "‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"

echo ""
echo "üéØ –û—Å–Ω–æ–≤–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "  ‚úì –£–±—Ä–∞–Ω–æ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö API"
echo "  ‚úì –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª)"
echo "  ‚úì –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –ø—Ä–æ—Ñ–∏–ª–µ –∏–≥—Ä–æ–∫–∞"
echo "  ‚úì –ë–î —Ç–µ–ø–µ—Ä—å —è–≤–ª—è–µ—Ç—Å—è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã"
echo "  ‚úì Real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
echo ""
echo "üåê –°–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã:"
echo "  ‚Ä¢ –§—Ä–æ–Ω—Ç–µ–Ω–¥: http://localhost:3000"
echo "  ‚Ä¢ API: http://localhost:3001"
echo "  ‚Ä¢ Health check: http://localhost:3001/api/health"
echo ""
echo "üìù –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
echo "  kill $SERVER_PID $FRONTEND_PID"
echo "  –∏–ª–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ: ./stop-services.sh"
echo ""

# –°–æ–∑–¥–∞–µ–º —Å–∫—Ä–∏–ø—Ç –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
cat > stop-services.sh << 'EOF'
#!/bin/bash
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å—ã..."

if [ -f "server.pid" ]; then
    SERVER_PID=$(cat server.pid)
    kill $SERVER_PID 2>/dev/null && echo "‚úÖ –°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || echo "‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    rm -f server.pid
fi

if [ -f "frontend.pid" ]; then
    FRONTEND_PID=$(cat frontend.pid)
    kill $FRONTEND_PID 2>/dev/null && echo "‚úÖ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω" || echo "‚ö†Ô∏è –§—Ä–æ–Ω—Ç–µ–Ω–¥ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    rm -f frontend.pid
fi

# –£–±–∏–≤–∞–µ–º –≤—Å–µ —Å–≤—è–∑–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pkill -f "node.*server" 2>/dev/null || true
pkill -f "npm.*start" 2>/dev/null || true
pkill -f "next" 2>/dev/null || true

echo "‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
EOF

chmod +x stop-services.sh

log "üéâ –ì–æ—Ç–æ–≤–æ! –ü—Ä–æ–±–ª–µ–º—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã."

echo ""
echo "üîç –î–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –ª–æ–≥–æ–≤:"
echo "  ‚Ä¢ –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞: tail -f server/logs/server.log (–µ—Å–ª–∏ –µ—Å—Ç—å)"
echo "  ‚Ä¢ –õ–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞"
echo ""
echo "‚ö° –ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:"
echo "  1. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–µ–ø–µ—Ä—å –í–°–ï–ì–î–ê —è–≤–ª—è–µ—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–æ–º –∏—Å—Ç–∏–Ω—ã"
echo "  2. –ö–ª–∏–µ–Ω—Ç –ù–ï —Å–æ–∑–¥–∞–µ—Ç –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö"
echo "  3. –£–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ü–∏–∫–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è"
echo "  4. –î–æ–±–∞–≤–ª–µ–Ω –¥–µ–±–∞—É–Ω—Å–∏–Ω–≥ –¥–ª—è –ø–æ–ª–µ–π –≤–≤–æ–¥–∞"
echo "  5. Real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ"
