# 🚀 ПРАВИЛЬНЫЙ ЗАПУСК ПРИЛОЖЕНИЯ

## 🎯 ВАЖНО: Два приложения в одном!

Ваш проект состоит из **ДВУХ** частей:

1. **🔧 Бэкенд** (`server/server.js`) - API сервер на порту 3001
2. **🌐 Фронтенд** (Next.js) - веб-интерфейс на порту 3000

## ⚙️ Как это работает:

```
┌─────────────────────────────────────────────────────────┐
│                 ecosystem.config.js                     │
│  ┌─────────────────────┐   ┌───────────────────────────┐ │
│  │   malabar-server    │   │    malabar-frontend       │ │
│  │  (API на :3001)     │   │   (Next.js на :3000)      │ │
│  │                     │   │                           │ │
│  │  ./server/server.js │◄──┤  npm start                │ │
│  │                     │   │                           │ │
│  └─────────────────────┘   └───────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

## 🔧 Что я делал неправильно:

### ❌ НЕПРАВИЛЬНО (запускал только бэкенд):
```bash
pm2 start ecosystem.config.js --only malabar-server
```

### ✅ ПРАВИЛЬНО (запускаю оба):
```bash
pm2 start ecosystem.config.js
```

## 🚀 Правильные команды для VPS:

### Полный перезапуск:
```bash
# 1. Останавливаем всё
pm2 stop all
pm2 delete all

# 2. Устанавливаем зависимости
cd server && npm install && cd ..
npm install

# 3. Создаем директории
node create-logs-dir.js

# 4. Запускаем ОБА приложения
pm2 start ecosystem.config.js

# 5. Проверяем
pm2 status
```

### Автоматически (исправленный скрипт):
```bash
./fix-and-restart-server.sh
```

## 📊 Что должно быть в pm2 status:

```bash
pm2 status
┌─────────────────┬────┬─────────────┬─────────┬─────────┬──────────┐
│ App name        │ id │ version     │ mode    │ pid     │ status   │
├─────────────────┼────┼─────────────┼─────────┼─────────┼──────────┤
│ malabar-server  │ 0  │ 1.0.0       │ fork    │ 12345   │ online   │
│ malabar-frontend│ 1  │ 0.1.0       │ fork    │ 12346   │ online   │
└─────────────────┴────┴─────────────┴─────────┴─────────┴──────────┘
```

## 🌐 Проверки доступности:

### API (бэкенд):
```bash
curl http://localhost:3001/api/health
# Должно вернуть: {"status":"OK","timestamp":"..."}
```

### Веб-интерфейс (фронтенд):
```bash
curl -I http://localhost:3000
# Должно вернуть: HTTP/1.1 200 OK
```

### В браузере:
- **Фронтенд**: http://46.173.17.229:3000 (или ваш домен)
- **API**: http://46.173.17.229:3001/api/health

## 🔍 Диагностика проблем:

### Если бэкенд не работает:
```bash
pm2 logs malabar-server
```

### Если фронтенд не работает:
```bash
pm2 logs malabar-frontend
```

### Если порт занят:
```bash
lsof -i :3000  # фронтенд
lsof -i :3001  # бэкенд
```

## 🛠️ Частые проблемы:

### 1. **Next.js не собирается**
```bash
# Сборка вручную
npm run build
npm start
```

### 2. **Зависимости не установлены**
```bash
# Корневая директория (фронтенд)
npm install

# Сервер (бэкенд)
cd server && npm install && cd ..
```

### 3. **Права доступа**
```bash
chmod 755 server/server.js
chmod +x fix-and-restart-server.sh
```

## 🎯 Итог:

- **ecosystem.config.js** = конфигурация для PM2 (КАК запускать)
- **server/server.js** = код бэкенда (ЧТО запускать)
- **pages/*** = код фронтенда (Next.js)

Мы правим код в `server.js`, но запускаем через `ecosystem.config.js` чтобы PM2 управлял процессами и логами.

**И да, я забыл запустить фронтенд! Теперь исправил.** 😅

---

**Статус**: ✅ Исправлено  
**Команда**: `./fix-and-restart-server.sh`
