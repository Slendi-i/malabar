#!/bin/bash

# –ü–æ—à–∞–≥–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –±–µ–∑ –∑–∞–≤–∏—Å–∞—é—â–∏—Ö –∫–æ–º–∞–Ω–¥
# –ö–∞–∂–¥—ã–π —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è

echo "üîß –ü–æ—à–∞–≥–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ VPS (–±–µ–∑ –∑–∞–≤–∏—Å–∞–Ω–∏–π)"
echo "==============================================="

# –¶–≤–µ—Ç–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log() {
    echo -e "${GREEN}[OK]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
cd /var/www/malabar || {
    error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è /var/www/malabar –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
}

echo "üìç –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "üìä –ú–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ:"
df -h . | head -2

echo ""
echo "üõë –®–ê–ì 1: –ë—ã—Å—Ç—Ä–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤"
echo "====================================="

info "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pkill -f "node.*server" 2>/dev/null && log "Node –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" || info "Node –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
pkill -f "npm.*start" 2>/dev/null && log "npm –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã" || info "npm –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

# PM2 —Å –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º
if command -v pm2 > /dev/null; then
    (timeout 5 pm2 stop all || pkill -f pm2) 2>/dev/null
    (timeout 5 pm2 delete all || true) 2>/dev/null
    log "PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
else
    info "PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω"
fi

sleep 2
log "–ü—Ä–æ—Ü–µ—Å—Å—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"

echo ""
echo "üßπ –®–ê–ì 2: –ë—ã—Å—Ç—Ä–∞—è –æ—á–∏—Å—Ç–∫–∞"
echo "========================="

info "–£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —Ñ–∞–π–ª—ã..."
rm -rf node_modules server/node_modules .next out 2>/dev/null && log "–í—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"
rm -f package-lock.json server/package-lock.json 2>/dev/null && log "lock —Ñ–∞–π–ª—ã —É–¥–∞–ª–µ–Ω—ã"

# –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–µ–π –ë–ï–ó –∑–∞–≤–∏—Å–∞–Ω–∏—è
if command -v npm > /dev/null; then
    timeout 10 npm cache clean --force 2>/dev/null || log "npm cache –æ—á–∏—â–µ–Ω (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ)"
fi

log "–û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

echo ""
echo "üì¶ –®–ê–ì 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ package.json"
echo "==============================="

if [ -f "package.json" ] && [ -f "server/package.json" ]; then
    log "package.json —Ñ–∞–π–ª—ã –Ω–∞–π–¥–µ–Ω—ã"
else
    error "–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç package.json —Ñ–∞–π–ª—ã!"
    echo "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞"
    exit 1
fi

echo ""
echo "üèóÔ∏è –®–ê–ì 4: –°–æ–∑–¥–∞–Ω–∏–µ –±–∞–∑–æ–≤–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã"
echo "===================================="

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
mkdir -p logs server
chmod 755 logs server
log "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å–æ–∑–¥–∞–Ω—ã"

# –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç—É—é PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'malabar-server',
      script: 'server.js',
      cwd: './server',
      instances: 1,
      watch: false,
      env: { NODE_ENV: 'production', PORT: 3001 }
    }
  ]
};
EOF

log "PM2 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞"

echo ""
echo "üíæ –®–ê–ì 5: –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
echo "============================="

if [ -f "server/malabar.db" ]; then
    DB_SIZE=$(stat -c%s "server/malabar.db" 2>/dev/null || echo "0")
    log "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–π–¥–µ–Ω–∞ ($DB_SIZE –±–∞–π—Ç)"
    chmod 664 server/malabar.db 2>/dev/null || true
elif [ -f "malabar.db" ]; then
    mv malabar.db server/ 2>/dev/null && log "–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ server/"
else
    touch server/malabar.db
    log "–°–æ–∑–¥–∞–Ω–∞ –ø—É—Å—Ç–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
fi

echo ""
echo "‚ö†Ô∏è –í–ê–ñ–ù–û: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
echo "================================"

echo "–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ - —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π."
echo "–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 5-15 –º–∏–Ω—É—Ç –∏ —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞."
echo ""
echo "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:"
echo "1. –ë—ã—Å—Ç—Ä–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (—Ç–æ–ª—å–∫–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞–∫–µ—Ç—ã)"
echo "2. –ü–æ–ª–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–≤—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏)"  
echo "3. –†—É—á–Ω–∞—è —É—Å—Ç–∞–Ω–æ–≤–∫–∞ (–∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è)"
echo "4. –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —É—Å—Ç–∞–Ω–æ–≤–∫—É (—Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ)"
echo ""

# –ñ–¥–µ–º –≤–≤–æ–¥–∞ –ë–ï–ó –∑–∞–≤–∏—Å–∞–Ω–∏—è
echo -n "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä (1-4): "
read -t 30 CHOICE 2>/dev/null || CHOICE="1"

case $CHOICE in
    "2")
        echo ""
        echo "üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
        ./install-deps-safe-vps.sh
        ;;
    "3")
        echo ""
        echo "üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä—É—á–Ω–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏:"
        echo "================================"
        echo "# –í –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:"
        echo "npm install --production --no-optional"
        echo ""
        echo "# –í –ø–∞–ø–∫–µ server:"
        echo "cd server && npm install --production --no-optional && cd .."
        echo ""
        echo "# –ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:"
        echo "./continue-restore-vps.sh"
        exit 0
        ;;
    "4")
        echo ""
        warn "–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–æ–ø—É—â–µ–Ω–∞"
        echo "–î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –ø–æ—Ç–æ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
        echo "  ./install-deps-safe-vps.sh"
        echo "  ./continue-restore-vps.sh"
        exit 0
        ;;
    *)
        echo ""
        echo "üöÄ –ó–∞–ø—É—Å–∫ –±—ã—Å—Ç—Ä–æ–π —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
        ./install-critical-deps-vps.sh
        ;;
esac

echo ""
echo "‚úÖ –ü–æ—à–∞–≥–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å: ls node_modules | wc -l"
echo "2. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä: ./start-server-simple-vps.sh"  
echo "3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É: ./test-simple-vps.sh"
echo ""
echo "üÜò –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:"
echo "  ./diagnose-simple-vps.sh"
