#!/bin/bash

echo "üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ò –ü–ï–†–ï–ó–ê–ü–£–°–ö –°–ï–†–í–ï–†–ê"
echo "===================================="

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã PM2
echo "üõë –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 stop all

# –£–¥–∞–ª—è–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∏–∑ PM2
echo "üóëÔ∏è –û—á–∏—â–∞–µ–º PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã..."
pm2 delete all

# –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤
echo "üìÅ –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ª–æ–≥–æ–≤..."
node create-logs-dir.js

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –∏ —Å–æ–±–∏—Ä–∞–µ–º
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞..."
npm install --no-audit --no-fund
echo "üèóÔ∏è –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (Next.js build)..."
npm run build || { echo "‚ùå –°–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å"; exit 1; }

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ server –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
echo "üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
cd server
echo "üßπ –û—á–∏—â–∞–µ–º node_modules —Å–µ—Ä–≤–µ—Ä–∞ (–≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ invalid ELF)..."
rm -rf node_modules
echo "üì• –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∑–∞–Ω–æ–≤–æ..."
npm install
cd ..

# –ß–∏–Ω–∏–º sqlite3 (–ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –ø–æ–¥ —Ç–µ–∫—É—â—É—é –ø–ª–∞—Ç—Ñ–æ—Ä–º—É)
if [ -f "fix-sqlite3.sh" ]; then
  echo "üõ†Ô∏è –ü–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ–º sqlite3 –ø–æ–¥ VPS..."
  chmod +x fix-sqlite3.sh
  ./fix-sqlite3.sh || echo "‚ö†Ô∏è –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ sqlite3 –∑–∞–≤–µ—Ä—à–∏–ª–∞—Å—å —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏"
else
  echo "‚ÑπÔ∏è –°–∫—Ä–∏–ø—Ç fix-sqlite3.sh –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–µ—Å–±–æ—Ä–∫—É"
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ñ–∞–π–ª—ã –Ω–∞ –º–µ—Å—Ç–µ
echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∞–π–ª—ã..."
echo "‚úì server/server.js:" $([ -f "server/server.js" ] && echo "OK" || echo "–û–¢–°–£–¢–°–¢–í–£–ï–¢")
echo "‚úì ecosystem.config.js:" $([ -f "ecosystem.config.js" ] && echo "OK" || echo "–û–¢–°–£–¢–°–¢–í–£–ï–¢")
echo "‚úì server/package.json:" $([ -f "server/package.json" ] && echo "OK" || echo "–û–¢–°–£–¢–°–¢–í–£–ï–¢")

# –ó–∞–ø—É—Å–∫–∞–µ–º –û–ë–ê –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2 (—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ + –±—ç–∫–µ–Ω–¥)
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –±—ç–∫–µ–Ω–¥ —á–µ—Ä–µ–∑ PM2..."
pm2 start ecosystem.config.js

# –ñ–¥–µ–º –Ω–µ–º–Ω–æ–≥–æ
sleep 4

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
pm2 status | cat

echo ""
echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫, –±–µ–∑ —Å—Ç—Ä–∏–º–∞):"
pm2 logs malabar-server --lines 50 --nostream | cat

echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å API:"
curl -sS --max-time 5 http://localhost:3001/api/health || echo "API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
echo "üåê –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:"
curl -sS --max-time 8 -I http://localhost:3000 | head -1 || echo "–§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"

echo ""
echo "üìä –û–±–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å online:"
pm2 status | grep -E "(malabar-server|malabar-frontend)" | cat

echo ""
echo "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å –≤—ã—à–µ."
