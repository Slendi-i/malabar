#!/bin/bash

echo "üîß –ü–û–®–ê–ì–û–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï"
echo "========================"

echo "–®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –±–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç..."
echo "----------------------------------------------"

if ! pm2 list | grep -q "online"; then
    echo "‚ùå PM2 –ø—Ä–æ—Ü–µ—Å—Å—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç. –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
    echo "./rollback-to-working.sh"
    exit 1
fi

echo "‚úÖ –ë–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–∞—á–∏–Ω–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è..."

echo ""
echo "–®–ê–ì 2: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—à–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏..."
echo "-----------------------------------------"

# –î–µ–ª–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
cp /var/www/malabar/pages/index.js /var/www/malabar/pages/index.js.backup

# –ú–µ–Ω—è–µ–º top-4 left-4 –Ω–∞ bottom-4 right-4 –¢–û–õ–¨–ö–û –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
sed -i 's/absolute top-4 left-4 z-50/absolute bottom-4 right-4 z-50/g' /var/www/malabar/pages/index.js

echo "‚úÖ –ü–ª–∞—à–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞"

echo ""
echo "–®–ê–ì 3: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ frontend –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
echo "----------------------------------------------------"
pm2 restart malabar-frontend

sleep 3
pm2 status

echo ""
echo "–®–ê–ì 4: –¢–µ—Å—Ç –ø–ª–∞—à–∫–∏..."
echo "--------------------"
echo "–û—Ç–∫—Ä–æ–π—Ç–µ http://46.173.17.229:3000"
echo "–ü–ª–∞—à–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞"
echo ""
echo "–ï—Å–ª–∏ –ø–ª–∞—à–∫–∞ –ù–ï –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "cp /var/www/malabar/pages/index.js.backup /var/www/malabar/pages/index.js"
echo "pm2 restart malabar-frontend"

echo ""
echo "–®–ê–ì 5: –°–≤–æ–±–æ–¥–Ω–æ–µ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ (–¢–û–õ–¨–ö–û –µ—Å–ª–∏ –ø–ª–∞—à–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)..."
echo "----------------------------------------------------------------"
read -p "–ü–ª–∞—à–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞? (y/n): " response

if [ "$response" = "y" ]; then
    echo "–ü—Ä–∏–º–µ–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è..."
    
    # –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è
    cp /var/www/malabar/components/PlayerIcons.js /var/www/malabar/components/PlayerIcons.js.backup
    
    # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –±–æ–ª–µ–µ –ø—Ä–æ—Å—Ç—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –¥–ª—è –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏—è
    echo "–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ —Å–ª–µ–¥—É—é—â–µ–º –∫–æ–º–º–∏—Ç–µ"
    
else
    echo "‚ùå –ü–ª–∞—à–∫–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º—Å—è"
    echo "–ù—É–∂–Ω–æ —Å–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–∑–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É"
fi

echo ""
echo "‚úÖ –ü–û–®–ê–ì–û–í–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û"
echo ""
echo "–°–¢–ê–¢–£–°:"
pm2 status
echo ""
echo "–¢–ï–°–¢–´:"
echo "1. http://46.173.17.229:3000 - –ø–ª–∞—à–∫–∞ –≤–Ω–∏–∑—É —Å–ø—Ä–∞–≤–∞?"
echo "2. –ú–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ –∫–∞–∫ admin/admin?"
echo "3. –ó–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ª–∏ –∏–≥—Ä–æ–∫–∏?"
