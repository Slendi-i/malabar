# üö® –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å WebSocket

## –ü—Ä–æ–±–ª–µ–º–∞
```
WebSocket connection to 'ws://46.173.17.229:3001/ws' failed
WebSocket error: Event
WebSocket disconnected: 1006
```

–ö–æ–¥ –æ—à–∏–±–∫–∏ 1006 = –∞–Ω–æ–º–∞–ª—å–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è.

## üîß –ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ VPS
```bash
# –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
chmod +x fix-websocket-issues.sh
./fix-websocket-issues.sh
```

### –®–∞–≥ 2: –†—É—á–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ (–µ—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –Ω–µ –ø–æ–º–æ–≥–ª–æ)
```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
chmod +x debug-websocket.sh
./debug-websocket.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 status
pm2 logs malabar-backend

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
netstat -tlnp | grep :3001
```

### –®–∞–≥ 3: –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è

#### 1. –°–µ—Ä–≤–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω
```bash
pm2 restart malabar-backend
pm2 logs malabar-backend
```

#### 2. Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
```bash
sudo ufw allow 3001/tcp
sudo ufw status
```

#### 3. –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç—å ws –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
```bash
cd server
npm install ws
cd ..
pm2 restart malabar-backend
```

#### 4. –ü–æ—Ä—Ç –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
```bash
sudo fuser -k 3001/tcp
pm2 restart malabar-backend
```

#### 5. –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π PM2
```bash
pm2 delete all
pm2 start ecosystem.config.js
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket

### –í–µ–±-—Ç–µ—Å—Ç
–û—Ç–∫—Ä–æ–π—Ç–µ —Ñ–∞–π–ª `websocket-test.html` –≤ –±—Ä–∞—É–∑–µ—Ä–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ö–æ–º–∞–Ω–¥–Ω–∞—è —Å—Ç—Ä–æ–∫–∞
```bash
# –¢–µ—Å—Ç WebSocket —á–µ—Ä–µ–∑ curl
curl -i -N \
     -H "Connection: Upgrade" \
     -H "Upgrade: websocket" \
     -H "Sec-WebSocket-Version: 13" \
     -H "Sec-WebSocket-Key: dGVzdA==" \
     http://46.173.17.229:3001/ws
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
```javascript
// –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
const ws = new WebSocket('ws://46.173.17.229:3001/ws');
ws.onopen = () => console.log('WebSocket –æ—Ç–∫—Ä—ã—Ç');
ws.onerror = (e) => console.log('–û—à–∏–±–∫–∞ WebSocket:', e);
ws.onclose = (e) => console.log('WebSocket –∑–∞–∫—Ä—ã—Ç:', e.code);
```

## ‚úÖ –£–ª—É—á—à–µ–Ω–∏—è –¥–æ–±–∞–≤–ª–µ–Ω—ã

### 1. HTTP Fallback
–¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ WebSocket –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç—Å—è –Ω–∞ HTTP polling.

### 2. –£–ª—É—á—à–µ–Ω–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è
- üü¢ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ (WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç)
- üîµ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (—É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
- üü† –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ... (–ø–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ)
- üü£ HTTP —Ä–µ–∂–∏–º (fallback —Ä–µ–∂–∏–º)
- üî¥ –û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–ø—Ä–æ–±–ª–µ–º—ã —Å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º)

### 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
- –î–æ 5 –ø–æ–ø—ã—Ç–æ–∫ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ HTTP –ø—Ä–∏ –Ω–µ—É–¥–∞—á–µ

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

```bash
# –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ WebSocket
curl http://localhost:3001/api/health

# –õ–æ–≥–∏
pm2 logs malabar-backend --lines 20
```

–í –±—Ä–∞—É–∑–µ—Ä–µ –¥–æ–ª–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å:
- üü¢ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ" - –µ—Å–ª–∏ WebSocket —Ä–∞–±–æ—Ç–∞–µ—Ç
- üü£ "HTTP —Ä–µ–∂–∏–º" - –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback

## üìû –ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã –æ—Å—Ç–∞—é—Ç—Å—è

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞**: `pm2 logs malabar-backend`
2. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ**: `pm2 restart all`
3. **–ü–æ–ª–Ω–∞—è –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–∞**: `./scripts/deploy.sh`
4. **–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å —Å –ª–æ–≥–∞–º–∏** –∏–∑ `debug-websocket.sh`

## üõ°Ô∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≤ –±—É–¥—É—â–µ–º

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
```bash
# –î–æ–±–∞–≤—å—Ç–µ –≤ cron –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
echo "*/5 * * * * /opt/malabar-event/scripts/monitor.sh" | crontab -
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–±–æ—è—Ö
PM2 —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö.

## üåê –†–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
- **Frontend**: http://46.173.17.229:3000 (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
- **Backend**: http://46.173.17.229:3001 (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞)
- **WebSocket**: ws://46.173.17.229:3001/ws (—Ä–∞–±–æ—Ç–∞–µ—Ç –∏–ª–∏ fallback –Ω–∞ HTTP)
- **Real-time —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è**: —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ!
